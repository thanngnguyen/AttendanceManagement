@model AttendanceManagement.ViewModels.ClassDetailViewModel
@{
    ViewData["Title"] = Model.Class.ClassName;
}

<div class="glass-bg-indigo">
    <div class="container-fluid">
        <!-- Banner Header -->
        <div class="row mb-4">
            <div class="col-12">
                @if (!string.IsNullOrEmpty(Model.Class.BannerImageUrl))
                {
                    <div class="glass-card" style="overflow: hidden; padding: 0;">
                        <div style="position: relative; height: 250px;">
                            <img src="@Model.Class.BannerImageUrl" alt="Banner" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; 
                                        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); 
                                        padding: 30px;">
                                <h2 class="text-white mb-2" style="font-weight: 800; text-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                                    @Model.Class.ClassName
                                </h2>
                                <p class="text-white mb-0" style="font-size: 1.1rem; text-shadow: 0 2px 6px rgba(0,0,0,0.5);">
                                    <i class="fas fa-book"></i> @Model.Class.Subject
                                </p>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="glass-card">
                        <div class="glass-header">
                            <h2 class="mb-2">@Model.Class.ClassName</h2>
                            <p class="text-glass mb-1"><i class="fas fa-book icon-glow"></i> @Model.Class.Subject</p>
                            <p class="text-glass mb-1"><i class="fas fa-user-tie icon-glow"></i> @Model.Class.Teacher.FullName</p>
                            @if (!string.IsNullOrEmpty(Model.Class.Room))
                            {
                                <p class="text-glass mb-0"><i class="fas fa-door-open icon-glow"></i> Phòng: @Model.Class.Room</p>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Glass Tabs -->
                <div class="glass-card mb-4">
                    <div class="glass-header">
                        <ul class="nav nav-tabs border-0 mb-0" id="classTab" role="tablist" style="gap: 10px;">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active glass-box" id="stream-tab" data-bs-toggle="tab" 
                                        data-bs-target="#stream" type="button" style="border: none;">
                                    <i class="fas fa-stream"></i> Bảng tin
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link glass-box" id="assignments-tab" data-bs-toggle="tab" 
                                        data-bs-target="#assignments" type="button" style="border: none;">
                                    <i class="fas fa-tasks"></i> Bài tập
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link glass-box" id="attendance-tab" data-bs-toggle="tab" 
                                        data-bs-target="#attendance" type="button" style="border: none;">
                                    <i class="fas fa-clipboard-check"></i> Điểm danh
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link glass-box" id="members-tab" data-bs-toggle="tab" 
                                        data-bs-target="#members" type="button" style="border: none;">
                                    <i class="fas fa-users"></i> Thành viên
                                </button>
                            </li>
                        </ul>
                    </div>

                    <div class="glass-body">
                        <div class="tab-content" id="classTabContent">
                            <!-- Stream Tab -->
                            <div class="tab-pane fade show active" id="stream" role="tabpanel">
                                @if (Model.IsTeacher || Model.IsEnrolled)
                                {
                                    <div class="glass-card-sm mb-4">
                                        <form asp-controller="Class" asp-action="CreatePost" method="post" enctype="multipart/form-data">
                                            <input type="hidden" name="ClassId" value="@Model.Class.ClassId" />
                                            @Html.AntiForgeryToken()
                                            
                                            <div class="mb-3">
                                                <textarea name="Content" class="form-control glass-input" rows="3" 
                                                          placeholder="Chia sẻ với lớp học..." required></textarea>
                                            </div>

                                            @if (Model.IsTeacher)
                                            {
                                                <div class="mb-3">
                                                    <select name="Type" class="form-select glass-input">
                                                        <option value="0">Thông báo</option>
                                                        <option value="1">Thảo luận</option>
                                                        <option value="2">Câu hỏi</option>
                                                    </select>
                                                </div>
                                            }

                                            <div class="mb-3">
                                                <input type="file" name="Attachment" class="form-control glass-input" style="padding: 12px;" />
                                            </div>

                                            <button type="submit" class="btn btn-gradient-primary">
                                                <i class="fas fa-paper-plane"></i> Đăng
                                            </button>
                                        </form>
                                    </div>
                                }

                                @if (Model.RecentPosts.Count == 0)
                                {
                                    <div class="glass-alert-info text-center">
                                        <i class="fas fa-info-circle fa-3x icon-glow mb-3"></i>
                                        <p class="mb-0">Chưa có bài đăng nào</p>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var post in Model.RecentPosts)
                                    {
                                        <div class="glass-card-sm mb-3">
                                            <div class="d-flex align-items-start">
                                                <div class="me-3">
                                                    <div class="d-flex align-items-center justify-content-center" 
                                                         style="width: 45px; height: 45px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)); 
                                                                border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);">
                                                        <i class="fas fa-user icon-glow"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="text-white mb-1">@post.Author.FullName</h6>
                                                    <small class="text-glass-muted">@post.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                                    
                                                    @switch (post.Type)
                                                    {
                                                        case AttendanceManagement.Models.PostType.Announcement:
                                                            <span class="badge-glass ms-2" style="background: rgba(102, 126, 234, 0.3);">Thông báo</span>
                                                            break;
                                                        case AttendanceManagement.Models.PostType.Discussion:
                                                            <span class="badge-glass ms-2" style="background: rgba(67, 233, 123, 0.3);">Thảo luận</span>
                                                            break;
                                                        case AttendanceManagement.Models.PostType.Question:
                                                            <span class="badge-glass ms-2" style="background: rgba(251, 191, 36, 0.3);">Câu hỏi</span>
                                                            break;
                                                    }

                                                    <p class="text-glass mt-3 mb-2">@post.Content</p>

                                                    @if (!string.IsNullOrEmpty(post.AttachmentUrl))
                                                    {
                                                        <a href="@post.AttachmentUrl" target="_blank" class="btn btn-gradient-info btn-sm">
                                                            <i class="fas fa-paperclip"></i> Tệp đính kèm
                                                        </a>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>

                            <!-- Assignments Tab -->
                            <div class="tab-pane fade" id="assignments" role="tabpanel">
                                @if (Model.IsTeacher)
                                {
                                    <div class="mb-3">
                                        <a asp-controller="Assignment" asp-action="Create" asp-route-classId="@Model.Class.ClassId" 
                                           class="btn btn-gradient-success">
                                            <i class="fas fa-plus"></i> Tạo bài tập mới
                                        </a>
                                    </div>
                                }

                                @if (Model.UpcomingAssignments.Count == 0)
                                {
                                    <div class="glass-alert-info text-center">
                                        <i class="fas fa-info-circle fa-3x icon-glow mb-3"></i>
                                        <p class="mb-0">Chưa có bài tập nào</p>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var assignment in Model.UpcomingAssignments)
                                    {
                                        <a asp-controller="Assignment" asp-action="Detail" asp-route-id="@assignment.AssignmentId" 
                                           style="text-decoration: none;">
                                            <div class="glass-card-sm mb-3">
                                                <div class="d-flex w-100 justify-content-between align-items-start">
                                                    <h6 class="text-white mb-2">
                                                        <i class="fas fa-file-alt icon-glow"></i> @assignment.Title
                                                    </h6>
                                                    @if (assignment.DueDate.HasValue)
                                                    {
                                                        <span class="badge-glass" style="background: rgba(239, 68, 68, 0.3);">
                                                            <i class="fas fa-clock"></i> @assignment.DueDate.Value.ToString("dd/MM/yyyy HH:mm")
                                                        </span>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(assignment.Description))
                                                {
                                                    <p class="text-glass-muted mb-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                                        @assignment.Description
                                                    </p>
                                                }
                                                <small class="text-glass">Điểm tối đa: <strong>@assignment.MaxScore</strong></small>
                                            </div>
                                        </a>
                                    }
                                }
                            </div>

                            <!-- Attendance Tab -->
                            <div class="tab-pane fade" id="attendance" role="tabpanel">
                                @if (Model.IsTeacher)
                                {
                                    <div class="mb-3">
                                        <a asp-controller="Attendance" asp-action="CreateSlot" asp-route-classId="@Model.Class.ClassId" 
                                           class="btn btn-gradient-primary">
                                            <i class="fas fa-plus"></i> Tạo phiên điểm danh
                                        </a>
                                    </div>
                                }

                                @if (Model.RecentSlots.Count == 0)
                                {
                                    <div class="glass-alert-info text-center">
                                        <i class="fas fa-info-circle fa-3x icon-glow mb-3"></i>
                                        <p class="mb-0">Chưa có phiên điểm danh nào</p>
                                    </div>
                                }
                                else
                                {
                                    @foreach (var slot in Model.RecentSlots)
                                    {
                                        var isActive = DateTime.Now >= slot.StartTime && DateTime.Now <= slot.EndTime;
                                        var isPast = DateTime.Now > slot.EndTime;
                                        
                                        <a asp-controller="Attendance" asp-action="SlotDetail" asp-route-id="@slot.SlotId" 
                                           style="text-decoration: none;">
                                            <div class="glass-card-sm mb-3 @(isActive ? "border-success" : "")"
                                                 style="@(isActive ? "border: 2px solid rgba(67, 233, 123, 0.5) !important;" : "")">
                                                <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                                    <h6 class="text-white mb-0">
                                                        <i class="fas fa-clipboard-check icon-glow"></i> @slot.SlotName
                                                    </h6>
                                                    @if (isActive)
                                                    {
                                                        <span class="badge-glass pulse" style="background: rgba(67, 233, 123, 0.4);">
                                                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i> Đang diễn ra
                                                        </span>
                                                    }
                                                    else if (isPast)
                                                    {
                                                        <span class="badge-glass" style="background: rgba(156, 163, 175, 0.3);">Đã kết thúc</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge-glass" style="background: rgba(79, 172, 254, 0.3);">Sắp diễn ra</span>
                                                    }
                                                </div>
                                                <small class="text-glass-muted">
                                                    <i class="fas fa-clock"></i> @slot.StartTime.ToString("dd/MM/yyyy HH:mm")
                                                </small>
                                                @if (!string.IsNullOrEmpty(slot.Description))
                                                {
                                                    <p class="text-glass-muted mb-0 mt-2" style="font-size: 0.9rem;">@slot.Description</p>
                                                }
                                            </div>
                                        </a>
                                    }
                                }
                            </div>

                            <!-- Members Tab -->
                            <div class="tab-pane fade" id="members" role="tabpanel">
                                <div class="glass-card-sm mb-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));">
                                    <h6 class="text-white mb-3"><i class="fas fa-user-tie icon-glow"></i> Giáo viên</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <div class="d-flex align-items-center justify-content-center" 
                                                 style="width: 55px; height: 55px; background: rgba(255,255,255,0.15); 
                                                        border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);">
                                                <i class="fas fa-user fa-2x icon-glow"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h6 class="text-white mb-1">@Model.Class.Teacher.FullName</h6>
                                            <small class="text-glass-muted">@Model.Class.Teacher.Email</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-card-sm" style="background: linear-gradient(135deg, rgba(67, 233, 123, 0.2), rgba(56, 249, 215, 0.2));">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="text-white mb-0">
                                            <i class="fas fa-users icon-glow"></i> Sinh viên (@Model.TotalStudents)
                                        </h6>
                                        <a asp-action="Members" asp-route-id="@Model.Class.ClassId" class="btn btn-gradient-info btn-sm">
                                            Xem chi tiết
                                        </a>
                                    </div>
                                    <p class="text-glass mb-0">
                                        <a asp-action="Members" asp-route-id="@Model.Class.ClassId" class="glass-link">
                                            Xem danh sách @Model.TotalStudents sinh viên →
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Class Info -->
                <div class="glass-card mb-3">
                    <div class="glass-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle icon-glow"></i> Thông tin lớp học</h6>
                    </div>
                    <div class="glass-body">
                        <label class="form-label text-white mb-2">Mã lớp:</label>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control glass-input" value="@Model.Class.ClassCode" id="classCode" readonly>
                            <button class="btn btn-gradient-info" type="button" onclick="copyClassCode()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.Class.Description))
                        {
                            <div class="glass-box mb-3">
                                <strong class="text-white">Mô tả:</strong>
                                <p class="text-glass-muted mb-0 mt-2">@Model.Class.Description</p>
                            </div>
                        }

                        <div class="glass-divider"></div>

                        <div class="glass-box mb-2">
                            <i class="fas fa-users"></i> <strong>Thành viên:</strong> @Model.TotalStudents sinh viên
                        </div>
                        <div class="glass-box">
                            <i class="fas fa-calendar-plus"></i> <strong>Tạo ngày:</strong> @Model.Class.CreatedAt.ToString("dd/MM/yyyy")
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                @if (Model.IsTeacher)
                {
                    <div class="glass-card mb-3">
                        <div class="glass-header">
                            <h6 class="mb-0"><i class="fas fa-bolt icon-glow"></i> Hành động nhanh</h6>
                        </div>
                        <div class="glass-body">
                            <div class="d-grid gap-2">
                                <a asp-controller="Attendance" asp-action="CreateSlot" asp-route-classId="@Model.Class.ClassId" 
                                   class="btn btn-gradient-primary">
                                    <i class="fas fa-clipboard-check"></i> Tạo phiên điểm danh
                                </a>
                                <a asp-controller="Assignment" asp-action="Create" asp-route-classId="@Model.Class.ClassId" 
                                   class="btn btn-gradient-success">
                                    <i class="fas fa-tasks"></i> Tạo bài tập
                                </a>
                                <a asp-action="Members" asp-route-id="@Model.Class.ClassId" 
                                   class="btn btn-gradient-info">
                                    <i class="fas fa-users"></i> Quản lý thành viên
                                </a>
                            </div>
                        </div>
                    </div>
                }

                <!-- Upcoming -->
                <div class="glass-card">
                    <div class="glass-header">
                        <h6 class="mb-0"><i class="fas fa-bell icon-glow"></i> Sắp tới</h6>
                    </div>
                    <div class="glass-body">
                        @if (Model.UpcomingAssignments.Count == 0 && Model.RecentSlots.Count == 0)
                        {
                            <p class="text-glass-muted mb-0">Không có hoạt động sắp tới</p>
                        }
                        else
                        {
                            @foreach (var assignment in Model.UpcomingAssignments.Take(3))
                            {
                                if (assignment.DueDate.HasValue)
                                {
                                    <div class="glass-box mb-2">
                                        <a asp-controller="Assignment" asp-action="Detail" asp-route-id="@assignment.AssignmentId" class="glass-link">
                                            <i class="fas fa-file-alt" style="color: #667eea;"></i> @assignment.Title
                                        </a>
                                        <br />
                                        <small class="text-glass-muted">Hạn: @assignment.DueDate.Value.ToString("dd/MM HH:mm")</small>
                                    </div>
                                }
                            }
                            @foreach (var slot in Model.RecentSlots.Where(s => s.StartTime > DateTime.Now).Take(3))
                            {
                                <div class="glass-box mb-2">
                                    <a asp-controller="Attendance" asp-action="SlotDetail" asp-route-id="@slot.SlotId" class="glass-link">
                                        <i class="fas fa-clipboard-check" style="color: #43e97b;"></i> @slot.SlotName
                                    </a>
                                    <br />
                                    <small class="text-glass-muted">@slot.StartTime.ToString("dd/MM HH:mm")</small>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function copyClassCode() {
            var copyText = document.getElementById("classCode");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);
            
            // Show success feedback
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                button.innerHTML = originalHTML;
            }, 2000);
        }

        // Tab activation
        document.addEventListener('DOMContentLoaded', function() {
            var tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabButtons.forEach(function(button) {
                button.addEventListener('shown.bs.tab', function(e) {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });
        });
    </script>
}
