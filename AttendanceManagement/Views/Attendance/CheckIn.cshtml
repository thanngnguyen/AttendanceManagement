@model AttendanceManagement.ViewModels.CheckInViewModel
@{
    ViewData["Title"] = "Điểm danh";
}

<div class="glass-bg-pink">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-7">
                <div class="glass-card">
                    <div class="glass-header">
                        <h4 class="mb-0">
                            <i class="fas fa-map-marker-alt icon-glow"></i> 
                            Điểm danh
                        </h4>
                    </div>
                    
                    <div class="glass-body">
                        @if (ViewBag.TestMode == true)
                        {
                            <div class="glass-alert-warning mb-4">
                                <strong><i class="fas fa-flask"></i> TEST MODE</strong><br />
                                Khoảng cách cho phép đã được tăng lên <strong>@ViewBag.AllowedDistance mét</strong> 
                                (gốc: @ViewBag.OriginalAllowedDistance mét) để dễ test.<br />
                                <small>Tắt TestMode trong appsettings.json để sử dụng chế độ production.</small>
                            </div>
                        }
                        
                        <div class="glass-alert-info mb-4">
                            <strong><i class="fas fa-info-circle"></i> Lưu ý:</strong>
                            <ul class="mt-2 mb-0" style="padding-left: 20px;">
                                <li>Bạn phải bật định vị trên thiết bị để điểm danh</li>
                                <li>Khoảng cách cho phép: <strong>@ViewBag.AllowedDistance mét</strong></li>
                                <li>Mỗi sinh viên chỉ được điểm danh một lần</li>
                            </ul>
                        </div>

                        <div class="glass-box mb-3">
                            <i class="fas fa-chalkboard"></i> <strong>Lớp học:</strong> @ViewBag.ClassName
                        </div>
                        <div class="glass-box mb-4">
                            <i class="fas fa-calendar-check"></i> <strong>Phiên:</strong> @ViewBag.SlotName
                        </div>

                        <div class="glass-card-sm mb-4" style="background: rgba(255, 182, 193, 0.2);">
                            <h6 class="text-white mb-3">
                                <i class="fas fa-map-pin icon-glow"></i> Vị trí lớp học
                            </h6>
                            <div class="glass-box mb-2">
                                <strong>Vĩ độ:</strong> <span id="slotLatDisplay">@ViewBag.SlotLatitude</span>
                            </div>
                            <div class="glass-box">
                                <strong>Kinh độ:</strong> <span id="slotLngDisplay">@ViewBag.SlotLongitude</span>
                            </div>
                        </div>

                        <form id="checkInForm">
                            <input type="hidden" asp-for="SlotId" />
                            <input type="hidden" asp-for="Latitude" id="latitude" />
                            <input type="hidden" asp-for="Longitude" id="longitude" />
                            @Html.AntiForgeryToken()

                            <div class="mb-4">
                                <label asp-for="StudentName" class="form-label">
                                    <i class="fas fa-user"></i> Họ và tên
                                </label>
                                <input asp-for="StudentName" class="form-control glass-input" readonly />
                            </div>

                            <div class="mb-4">
                                <label asp-for="StudentCode" class="form-label">
                                    <i class="fas fa-id-card"></i> Mã sinh viên
                                </label>
                                <input asp-for="StudentCode" class="form-control glass-input" readonly />
                            </div>

                            <div class="mb-4">
                                <label asp-for="Email" class="form-label">
                                    <i class="fas fa-envelope"></i> Email
                                </label>
                                <input asp-for="Email" class="form-control glass-input" readonly />
                            </div>

                            <div class="mb-4">
                                <label asp-for="PhoneNumber" class="form-label">
                                    <i class="fas fa-phone"></i> Số điện thoại
                                </label>
                                <input asp-for="PhoneNumber" class="form-control glass-input" placeholder="0123456789" />
                            </div>

                            <div class="glass-alert-info mb-4 pulse" id="locationStatus">
                                <i class="fas fa-spinner fa-spin"></i> Đang lấy vị trí của bạn...
                                <div class="mt-2" style="font-size: 0.85rem;">
                                    <small>⏱️ Vui lòng đợi 5-30 giây...</small>
                                </div>
                            </div>

                            <div id="locationInfo" class="mb-4" style="display:none;">
                                <div class="glass-card-sm" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));">
                                    <h6 class="text-white mb-3">
                                        <i class="fas fa-map-pin icon-glow"></i> Vị trí của bạn
                                    </h6>
                                    <div class="glass-box mb-2">
                                        <strong>Vĩ độ:</strong> <span id="displayLat"></span>
                                    </div>
                                    <div class="glass-box mb-2">
                                        <strong>Kinh độ:</strong> <span id="displayLng"></span>
                                    </div>
                                    <div class="glass-box mb-3">
                                        <strong>Độ chính xác:</strong> <span id="accuracy"></span> mét
                                    </div>
                                    <div class="glass-divider"></div>
                                    <div class="text-center glass-box">
                                        <small class="text-glass-muted d-block mb-1">Khoảng cách từ lớp</small>
                                        <span id="distance" class="text-white" style="font-size: 1.8rem; font-weight: 800;"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-3">
                                <button type="submit" class="btn btn-gradient-success btn-lg" id="submitBtn" disabled>
                                    <i class="fas fa-check-circle"></i> Xác nhận điểm danh
                                </button>
                                <button type="button" class="btn btn-gradient-info" id="retryBtn" style="display:none;">
                                    <i class="fas fa-sync-alt"></i> Thử lại
                                </button>
                                <a asp-action="SlotDetail" asp-route-id="@Model.SlotId" class="btn btn-gradient-secondary">
                                    <i class="fas fa-arrow-left"></i> Quay lại
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Parse and round slot location
        let slotLatRaw = '@(ViewBag.SlotLatitude ?? "0")'.replace(',', '.');
        let slotLngRaw = '@(ViewBag.SlotLongitude ?? "0")'.replace(',', '.');
        
        let slotLat = Math.round(parseFloat(slotLatRaw) * 1000000) / 1000000 || 0;
        let slotLng = Math.round(parseFloat(slotLngRaw) * 1000000) / 1000000 || 0;
        
        const allowedDistance = parseFloat('@(ViewBag.AllowedDistance ?? "100")') || 100;
        const hasSlotLocation = slotLat !== 0 && slotLng !== 0 && !isNaN(slotLat) && !isNaN(slotLng) &&
                                Math.abs(slotLat) <= 90 && Math.abs(slotLng) <= 180;
        
        let attempts = 0;
        const MAX_ATTEMPTS = 5;
        let gpsRequestInProgress = false;

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            const deltaLatRad = (lat2 - lat1) * Math.PI / 180;
            const deltaLonRad = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(deltaLatRad / 2) * Math.sin(deltaLatRad / 2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                      Math.sin(deltaLonRad / 2) * Math.sin(deltaLonRad / 2);
            
            const c = 2 * Math.asin(Math.min(1.0, Math.sqrt(a)));
            return R * c;
        }

        function handleLocationSuccess(position) {
            gpsRequestInProgress = false;
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const acc = position.coords.accuracy;
            
            const roundedLat = Math.round(lat * 1000000) / 1000000;
            const roundedLng = Math.round(lng * 1000000) / 1000000;
            
            $('#latitude').val(roundedLat);
            $('#longitude').val(roundedLng);
            $('#displayLat').text(roundedLat.toFixed(6));
            $('#displayLng').text(roundedLng.toFixed(6));
            $('#accuracy').text('±' + acc.toFixed(2));

            let distText = '';
            let statusHtml = '';
            let isValid = false;

            if (hasSlotLocation) {
                const userLocValid = Math.abs(roundedLat) <= 90 && Math.abs(roundedLng) <= 180 && !isNaN(roundedLat) && !isNaN(roundedLng);
                
                if (!userLocValid) {
                    distText = 'Vị trí không hợp lệ';
                    statusHtml = '<i class="fas fa-exclamation-triangle"></i> <strong>Lỗi: Vị trí không hợp lệ!</strong>';
                    $('#locationStatus').removeClass('pulse glass-alert-info').addClass('glass-alert-danger').html(statusHtml);
                } else {
                    const dist = calculateDistance(slotLat, slotLng, roundedLat, roundedLng);
                    distText = dist.toFixed(2) + ' mét';
                    
                    if (dist > allowedDistance) {
                        statusHtml = '<i class="fas fa-exclamation-triangle"></i> <strong>⚠️ Cảnh báo: Ngoài phạm vi!</strong><br><small>Khoảng cách: ' + dist.toFixed(2) + 'm > ' + allowedDistance + 'm</small>';
                        $('#locationStatus').removeClass('pulse glass-alert-info').addClass('glass-alert-warning').html(statusHtml);
                        isValid = true;
                    } else {
                        statusHtml = '<i class="fas fa-check-circle"></i> <strong>✅ Vị trí hợp lệ!</strong><br><small>Khoảng cách: ' + dist.toFixed(2) + 'm ≤ ' + allowedDistance + 'm</small>';
                        $('#locationStatus').removeClass('pulse glass-alert-info').addClass('glass-alert-success').html(statusHtml);
                        isValid = true;
                    }
                }
            } else {
                distText = 'Lớp không có GPS';
                statusHtml = '<i class="fas fa-check-circle"></i> <strong>✅ Đã lấy vị trí!</strong>';
                $('#locationStatus').removeClass('pulse glass-alert-info').addClass('glass-alert-success').html(statusHtml);
                isValid = true;
            }

            $('#distance').text(distText);
            $('#locationInfo').slideDown();
            if (isValid) $('#submitBtn').prop('disabled', false);
        }

        function handleLocationError(error) {
            gpsRequestInProgress = false;
            
            let msg = '';
            let detail = '';
            let canRetry = false;
            
            if (error.code === 1) {
                msg = 'Từ chối quyền truy cập GPS';
                detail = '1️⃣ Click 🔒 bên trái URL → 2️⃣ Chọn "Cho phép" → 3️⃣ Reload trang (F5)';
                canRetry = false;
            } else if (error.code === 2) {
                msg = 'Không xác định được vị trí';
                detail = '1️⃣ Bật GPS/Location → 2️⃣ Bật WiFi → 3️⃣ Ra ngoài trời';
                canRetry = attempts < MAX_ATTEMPTS;
            } else if (error.code === 3) {
                msg = 'Hết thời gian chờ';
                detail = '1️⃣ Bật GPS → 2️⃣ Ra ngoài trời → 3️⃣ Đảm bảo WiFi/dữ liệu tốt';
                canRetry = attempts < MAX_ATTEMPTS;
            } else {
                msg = 'Lỗi không xác định';
                detail = '1️⃣ Reload trang → 2️⃣ Kiểm tra mạng → 3️⃣ Liên hệ giáo viên';
                canRetry = attempts < MAX_ATTEMPTS;
            }
            
            let html = '<i class="fas fa-exclamation-triangle"></i> <strong>' + msg + '</strong><br><small>' + detail + '</small>';
            
            if (attempts >= MAX_ATTEMPTS) {
                html = '<i class="fas fa-exclamation-triangle"></i> <strong>❌ Đã thử ' + MAX_ATTEMPTS + ' lần!</strong><br><small>Liên hệ giáo viên để hỗ trợ</small>';
                canRetry = false;
            }
            
            $('#locationStatus').removeClass('pulse glass-alert-info').addClass('glass-alert-danger').html(html);
            if (canRetry) $('#retryBtn').show();
        }

        function getLocation() {
            if (gpsRequestInProgress) return;
            if (attempts >= MAX_ATTEMPTS) {
                $('#locationStatus').removeClass('pulse glass-alert-info').addClass('glass-alert-danger')
                    .html('<i class="fas fa-exclamation-triangle"></i> <strong>❌ Đã thử ' + MAX_ATTEMPTS + ' lần!</strong>');
                return;
            }

            attempts++;
            gpsRequestInProgress = true;
            
            $('#locationStatus')
                .removeClass('glass-alert-danger glass-alert-success glass-alert-warning')
                .addClass('glass-alert-info pulse')
                .html('<i class="fas fa-spinner fa-spin"></i> Đang lấy vị trí... (Lần #' + attempts + ')');
            
            $('#retryBtn').hide();
            
            if (!navigator.geolocation) {
                gpsRequestInProgress = false;
                $('#locationStatus').removeClass('glass-alert-info pulse').addClass('glass-alert-danger')
                    .html('<i class="fas fa-exclamation-triangle"></i> <strong>Lỗi: Trình duyệt không hỗ trợ GPS</strong>');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                handleLocationError,
                { enableHighAccuracy: true, timeout: 60000, maximumAge: 0 }
            );
        }

        $(document).ready(function() {
            getLocation();

            $('#retryBtn').click(getLocation);

            $('#checkInForm').submit(function(e) {
                e.preventDefault();
                
                const lat = $('#latitude').val();
                const lng = $('#longitude').val();
                
                if (!lat || !lng) {
                    alert('⚠️ Chưa lấy được vị trí!');
                    return false;
                }

                $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang xử lý...');

                $.ajax({
                    url: '@Url.Action("CheckIn", "Attendance")',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            alert('✅ ' + response.message);
                            window.location.href = '@Url.Action("SlotDetail", "Attendance", new { id = Model.SlotId })';
                        } else {
                            alert('❌ ' + response.message);
                            $('#submitBtn').prop('disabled', false).html('<i class="fas fa-check-circle"></i> Xác nhận điểm danh');
                        }
                    },
                    error: function() {
                        alert('❌ Lỗi kết nối!');
                        $('#submitBtn').prop('disabled', false).html('<i class="fas fa-check-circle"></i> Xác nhận điểm danh');
                    }
                });
                
                return false;
            });
        });
    </script>
}
