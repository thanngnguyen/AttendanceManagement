@model AttendanceManagement.ViewModels.AttendanceSlotDetailViewModel
@{
    ViewData["Title"] = Model.Slot.SlotName;
}

<div class="glass-bg-pink">
    <div class="container-fluid">
        <!-- Breadcrumb Glass -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="glass-box" style="padding: 12px 20px;">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0" style="background: transparent;">
                            <li class="breadcrumb-item">
                                <a asp-controller="Class" asp-action="Index" class="glass-link">Lớp học</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a asp-controller="Class" asp-action="Detail" asp-route-id="@Model.Class.ClassId" class="glass-link">@Model.Class.ClassName</a>
                            </li>
                            <li class="breadcrumb-item active text-white">@Model.Slot.SlotName</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <div class="glass-card mb-4">
                    <div class="glass-header">
                        <h4 class="mb-0">
                            <i class="fas fa-clipboard-check icon-glow"></i> @Model.Slot.SlotName
                        </h4>
                    </div>
                    <div class="glass-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="glass-box mb-2">
                                    <i class="fas fa-chalkboard"></i> <strong>Lớp học:</strong> @Model.Class.ClassName
                                </div>
                                <div class="glass-box">
                                    <i class="fas fa-user-tie"></i> <strong>Giáo viên:</strong> @Model.Class.Teacher.FullName
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="glass-box mb-2">
                                    <i class="fas fa-clock"></i> <strong>Bắt đầu:</strong> @Model.Slot.StartTime.ToString("dd/MM/yyyy HH:mm")
                                </div>
                                <div class="glass-box">
                                    <i class="fas fa-clock"></i> <strong>Kết thúc:</strong> @Model.Slot.EndTime.ToString("dd/MM/yyyy HH:mm")
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.Slot.Description))
                        {
                            <div class="glass-alert-info">
                                <strong><i class="fas fa-info-circle"></i> Ghi chú:</strong> @Model.Slot.Description
                            </div>
                        }

                        @if (!Model.IsTeacher)
                        {
                            <div class="d-grid gap-3 mb-3">
                                @if (Model.HasCheckedIn)
                                {
                                    <button class="btn btn-gradient-success btn-lg" disabled>
                                        <i class="fas fa-check-circle"></i> Đã điểm danh
                                    </button>
                                }
                                else if (Model.HasRequestedLeave)
                                {
                                    <button class="btn btn-gradient-secondary btn-lg" disabled>
                                        <i class="fas fa-file-medical"></i> Đã gửi đơn xin nghỉ
                                    </button>
                                }
                                else if (DateTime.Now < Model.Slot.StartTime)
                                {
                                    <button class="btn btn-gradient-secondary btn-lg" disabled>
                                        <i class="fas fa-clock"></i> Phiên chưa bắt đầu
                                    </button>
                                }
                                else if (DateTime.Now > Model.Slot.EndTime)
                                {
                                    <button class="btn btn-gradient-secondary btn-lg" disabled>
                                        <i class="fas fa-clock"></i> Phiên đã kết thúc
                                    </button>
                                }
                                else
                                {
                                    <a asp-action="CheckIn" asp-route-id="@Model.Slot.SlotId" class="btn btn-gradient-primary btn-lg">
                                        <i class="fas fa-map-marker-alt"></i> Điểm danh ngay
                                    </a>
                                    <a asp-action="RequestLeave" asp-route-id="@Model.Slot.SlotId" class="btn btn-gradient-info btn-lg">
                                        <i class="fas fa-file-medical"></i> Xin nghỉ phép
                                    </a>
                                }
                            </div>
                        }

                        @if (Model.MyAttendance != null)
                        {
                            <div class="glass-card-sm" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2)); border-color: rgba(16, 185, 129, 0.4);">
                                <h5 class="text-white mb-3"><i class="fas fa-check-circle icon-glow"></i> Thông tin điểm danh của bạn</h5>
                                <div class="glass-box mb-2">
                                    <strong>Thời gian:</strong> @Model.MyAttendance.CheckInTime.ToString("dd/MM/yyyy HH:mm:ss")
                                </div>
                                <div class="glass-box mb-2">
                                    <strong>Trạng thái:</strong>
                                    @switch (Model.MyAttendance.Status)
                                    {
                                        case AttendanceManagement.Models.AttendanceStatus.Present:
                                            <span class="badge-glass" style="background: rgba(16, 185, 129, 0.3);">Có mặt</span>
                                            break;
                                        case AttendanceManagement.Models.AttendanceStatus.Late:
                                            <span class="badge-glass" style="background: rgba(251, 191, 36, 0.3);">Đi muộn</span>
                                            break;
                                        case AttendanceManagement.Models.AttendanceStatus.Excused:
                                            <span class="badge-glass" style="background: rgba(59, 130, 246, 0.3);">Có phép</span>
                                            break;
                                        case AttendanceManagement.Models.AttendanceStatus.Absent:
                                            <span class="badge-glass" style="background: rgba(239, 68, 68, 0.3);">Vắng</span>
                                            break;
                                    }
                                </div>
                                <div class="glass-box mb-2">
                                    <strong>Khoảng cách:</strong> @Model.MyAttendance.DistanceFromClass.ToString("F2") mét
                                </div>
                                @if (Model.MyAttendance.IsFlagged)
                                {
                                    <div class="glass-alert-danger">
                                        <strong><i class="fas fa-exclamation-triangle"></i> Vi phạm:</strong> @Model.MyAttendance.FlagReason
                                    </div>
                                }
                            </div>
                        }

                        @if (Model.MyLeaveRequest != null)
                        {
                            <div class="glass-card-sm mt-3" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border-color: rgba(251, 191, 36, 0.4);">
                                <h5 class="text-white mb-3"><i class="fas fa-file-medical icon-glow"></i> Đơn xin nghỉ của bạn</h5>
                                <div class="glass-box mb-2">
                                    <strong>Lý do:</strong> @Model.MyLeaveRequest.Reason
                                </div>
                                <div class="glass-box mb-2">
                                    <strong>Thời gian gửi:</strong> @Model.MyLeaveRequest.RequestedAt.ToString("dd/MM/yyyy HH:mm")
                                </div>
                                <div class="glass-box mb-2">
                                    <strong>Trạng thái:</strong>
                                    @switch (Model.MyLeaveRequest.Status)
                                    {
                                        case AttendanceManagement.Models.LeaveRequestStatus.Pending:
                                            <span class="badge-glass" style="background: rgba(251, 191, 36, 0.3);">Chờ duyệt</span>
                                            break;
                                        case AttendanceManagement.Models.LeaveRequestStatus.Approved:
                                            <span class="badge-glass" style="background: rgba(16, 185, 129, 0.3);">Đã duyệt</span>
                                            break;
                                        case AttendanceManagement.Models.LeaveRequestStatus.Rejected:
                                            <span class="badge-glass" style="background: rgba(239, 68, 68, 0.3);">Từ chối</span>
                                            break;
                                    }
                                </div>
                                @if (Model.MyLeaveRequest.EvidenceUrl != null)
                                {
                                    <a href="@Model.MyLeaveRequest.EvidenceUrl" target="_blank" class="btn btn-gradient-info btn-sm">
                                        <i class="fas fa-file"></i> Xem minh chứng
                                    </a>
                                }
                                @if (!string.IsNullOrEmpty(Model.MyLeaveRequest.ReviewNote))
                                {
                                    <div class="glass-alert-info mt-2">
                                        <strong>Ghi chú từ giáo viên:</strong> @Model.MyLeaveRequest.ReviewNote
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Statistics Sidebar -->
            <div class="col-lg-4">
                <div class="glass-card mb-4">
                    <div class="glass-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie icon-glow"></i> Thống kê</h5>
                    </div>
                    <div class="glass-body">
                        <div class="glass-box mb-3 text-center">
                            <div class="text-glass-muted mb-2">Tổng sinh viên</div>
                            <h2 class="text-white mb-0">@Model.Statistics.TotalStudents</h2>
                        </div>

                        <div class="mb-3">
                            <div class="progress" style="height: 30px; background: rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden;">
                                <div class="progress-bar" style="background: linear-gradient(135deg, #43e97b, #38f9d7); width: @((Model.Statistics.TotalStudents > 0 ? (double)Model.Statistics.PresentCount / Model.Statistics.TotalStudents * 100 : 0).ToString("F0"))%">
                                    @Model.Statistics.PresentCount
                                </div>
                                <div class="progress-bar" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); width: @((Model.Statistics.TotalStudents > 0 ? (double)Model.Statistics.LateCount / Model.Statistics.TotalStudents * 100 : 0).ToString("F0"))%">
                                    @Model.Statistics.LateCount
                                </div>
                                <div class="progress-bar" style="background: linear-gradient(135deg, #4facfe, #00f2fe); width: @((Model.Statistics.TotalStudents > 0 ? (double)Model.Statistics.ExcusedCount / Model.Statistics.TotalStudents * 100 : 0).ToString("F0"))%">
                                    @Model.Statistics.ExcusedCount
                                </div>
                                <div class="progress-bar" style="background: linear-gradient(135deg, #f093fb, #f5576c); width: @((Model.Statistics.TotalStudents > 0 ? (double)Model.Statistics.AbsentCount / Model.Statistics.TotalStudents * 100 : 0).ToString("F0"))%">
                                    @Model.Statistics.AbsentCount
                                </div>
                            </div>
                        </div>

                        <div class="glass-box mb-2 d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-check" style="color: #43e97b;"></i> Có mặt</span>
                            <span class="badge-glass" style="background: rgba(67, 233, 123, 0.3);">@Model.Statistics.PresentCount</span>
                        </div>
                        <div class="glass-box mb-2 d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-clock" style="color: #fbbf24;"></i> Đi muộn</span>
                            <span class="badge-glass" style="background: rgba(251, 191, 36, 0.3);">@Model.Statistics.LateCount</span>
                        </div>
                        <div class="glass-box mb-2 d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-file-medical" style="color: #4facfe;"></i> Có phép</span>
                            <span class="badge-glass" style="background: rgba(79, 172, 254, 0.3);">@Model.Statistics.ExcusedCount</span>
                        </div>
                        <div class="glass-box mb-2 d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-times" style="color: #f5576c;"></i> Vắng</span>
                            <span class="badge-glass" style="background: rgba(245, 87, 108, 0.3);">@Model.Statistics.AbsentCount</span>
                        </div>
                        <div class="glass-box mb-3 d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-flag" style="color: #f5576c;"></i> Vi phạm</span>
                            <span class="badge-glass" style="background: rgba(239, 68, 68, 0.3);">@Model.Statistics.FlaggedCount</span>
                        </div>

                        <div class="text-center glass-box">
                            <h2 class="text-white mb-1" style="font-size: 2.5rem; font-weight: 800;">@Model.Statistics.AttendanceRate.ToString("F1")%</h2>
                            <small class="text-glass-muted">Tỷ lệ điểm danh</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (Model.IsTeacher)
        {
            <div class="row">
                <div class="col-12">
                    <div class="glass-card">
                        <div class="glass-header">
                            <ul class="nav nav-tabs border-0 mb-0" id="myTab" role="tablist" style="gap: 10px;">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active glass-box" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" style="border: none;">
                                        <i class="fas fa-users"></i> Danh sách điểm danh (@Model.AttendanceRecords.Count)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link glass-box" id="leave-tab" data-bs-toggle="tab" data-bs-target="#leave" type="button" style="border: none;">
                                        <i class="fas fa-file-medical"></i> Đơn xin nghỉ (@Model.LeaveRequests.Count)
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <div class="glass-body">
                            <div class="tab-content" id="myTabContent">
                                <div class="tab-pane fade show active" id="attendance" role="tabpanel">
                                    <div class="table-responsive">
                                        <table class="table glass-table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Mã SV</th>
                                                    <th>Họ tên</th>
                                                    <th>Email</th>
                                                    <th>Thời gian</th>
                                                    <th>Khoảng cách (m)</th>
                                                    <th>Trạng thái</th>
                                                    <th>Vi phạm</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var record in Model.AttendanceRecords)
                                                {
                                                    <tr style="@(record.IsFlagged ? "background: rgba(239, 68, 68, 0.1);" : "")">
                                                        <td>@(Model.AttendanceRecords.IndexOf(record) + 1)</td>
                                                        <td>@record.StudentCode</td>
                                                        <td>@record.StudentName</td>
                                                        <td>@record.Email</td>
                                                        <td>@record.CheckInTime.ToString("HH:mm:ss")</td>
                                                        <td>@record.DistanceFromClass.ToString("F2")</td>
                                                        <td>
                                                            @switch (record.Status)
                                                            {
                                                                case AttendanceManagement.Models.AttendanceStatus.Present:
                                                                    <span class="badge-glass" style="background: rgba(16, 185, 129, 0.3);">Có mặt</span>
                                                                    break;
                                                                case AttendanceManagement.Models.AttendanceStatus.Late:
                                                                    <span class="badge-glass" style="background: rgba(251, 191, 36, 0.3);">Đi muộn</span>
                                                                    break;
                                                            }
                                                        </td>
                                                        <td>
                                                            @if (record.IsFlagged)
                                                            {
                                                                <span class="badge-glass" style="background: rgba(239, 68, 68, 0.4);" title="@record.FlagReason">
                                                                    <i class="fas fa-flag"></i> @record.Flags.Count
                                                                </span>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="tab-pane fade" id="leave" role="tabpanel">
                                    @foreach (var request in Model.LeaveRequests)
                                    {
                                        <div class="glass-card-sm mb-3">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <h6 class="text-white">@request.StudentName (@request.StudentCode)</h6>
                                                    <div class="glass-box mb-2"><strong>Email:</strong> @request.Email</div>
                                                    <div class="glass-box mb-2"><strong>Lý do:</strong> @request.Reason</div>
                                                    <div class="glass-box mb-2"><strong>Thời gian:</strong> @request.RequestedAt.ToString("dd/MM/yyyy HH:mm")</div>
                                                    @if (request.EvidenceUrl != null)
                                                    {
                                                        <a href="@request.EvidenceUrl" target="_blank" class="btn btn-gradient-info btn-sm">
                                                            <i class="fas fa-file"></i> Xem minh chứng
                                                        </a>
                                                    }
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    @if (request.Status == AttendanceManagement.Models.LeaveRequestStatus.Pending)
                                                    {
                                                        <form asp-action="ReviewLeaveRequest" method="post" class="d-inline">
                                                            <input type="hidden" name="requestId" value="@request.RequestId" />
                                                            <input type="hidden" name="status" value="approved" />
                                                            <button type="submit" class="btn btn-gradient-success btn-sm mb-2">
                                                                <i class="fas fa-check"></i> Duyệt
                                                            </button>
                                                        </form>
                                                        <button type="button" class="btn btn-gradient-danger btn-sm" onclick="rejectRequest(@request.RequestId)">
                                                            <i class="fas fa-times"></i> Từ chối
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        @switch (request.Status)
                                                        {
                                                            case AttendanceManagement.Models.LeaveRequestStatus.Approved:
                                                                <span class="badge-glass" style="background: rgba(16, 185, 129, 0.3); padding: 10px 20px;">Đã duyệt</span>
                                                                break;
                                                            case AttendanceManagement.Models.LeaveRequestStatus.Rejected:
                                                                <span class="badge-glass" style="background: rgba(239, 68, 68, 0.3); padding: 10px 20px;">Từ chối</span>
                                                                break;
                                                        }
                                                        @if (!string.IsNullOrEmpty(request.ReviewNote))
                                                        {
                                                            <p class="text-glass-muted small mt-2">Ghi chú: @request.ReviewNote</p>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function rejectRequest(requestId) {
            const note = prompt('Nhập lý do từ chối (tùy chọn):');
            if (note !== null) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("ReviewLeaveRequest", "Attendance")';
                
                const requestIdInput = document.createElement('input');
                requestIdInput.type = 'hidden';
                requestIdInput.name = 'requestId';
                requestIdInput.value = requestId;
                form.appendChild(requestIdInput);
                
                const statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                statusInput.value = 'rejected';
                form.appendChild(statusInput);
                
                const noteInput = document.createElement('input');
                noteInput.type = 'hidden';
                noteInput.name = 'note';
                noteInput.value = note;
                form.appendChild(noteInput);
                
                const token = document.createElement('input');
                token.type = 'hidden';
                token.name = '__RequestVerificationToken';
                token.value = $('input[name="__RequestVerificationToken"]').val();
                form.appendChild(token);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Activate tabs
        document.addEventListener('DOMContentLoaded', function() {
            var tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabButtons.forEach(function(button) {
                button.addEventListener('shown.bs.tab', function(e) {
                    // Remove active class from all
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // Add to current
                    e.target.classList.add('active');
                });
            });
        });
    </script>
}
